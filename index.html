<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HungerHero — UAE • Donate & Find Food Banks</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #f6f8fb;
    --card: #ffffff;
    --accent: #ff6f61;
    --accent-2: #ff9472;
    --muted: #6b7280;
    --glass: rgba(255,255,255,0.75);
    --shadow: 0 10px 36px rgba(12,17,43,0.08);
    --radius: 14px;
    --navheight: 68px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#fbfdff 0,#eef7ff 100%);color:#071127;-webkit-font-smoothing:antialiased}
  a{color:inherit;text-decoration:none}
  /* top nav */
  .topnav{
    position:fixed;left:0;right:0;top:0;height:var(--navheight);display:flex;align-items:center;padding:10px 18px;background:rgba(255,255,255,0.80);backdrop-filter:blur(6px);box-shadow:0 6px 18px rgba(12,17,43,0.04);z-index:2000;
  }
  .brand{display:flex;gap:10px;align-items:center;font-weight:800;font-size:18px}
  .navlinks{margin-left:24px;display:flex;gap:12px;align-items:center}
  .navlinks a{padding:8px 10px;border-radius:10px;color:var(--muted);font-weight:700}
  .navlinks a.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}
  .nav-right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid rgba(12,17,43,0.06);padding:8px 12px;border-radius:10px;cursor:pointer}
  .container{max-width:1200px;margin:calc(var(--navheight) + 18px) auto;padding:18px}
  /* sections */
  section{margin-bottom:26px;scroll-margin-top:calc(var(--navheight) + 8px)}
  .hero{
    display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:stretch;padding:22px;border-radius:var(--radius);box-shadow:var(--shadow);background:linear-gradient(90deg, rgba(255,111,97,0.06), rgba(255,148,114,0.02));
  }
  .badge{display:inline-block;padding:6px 12px;border-radius:999px;background:rgba(255,111,97,0.12);color:var(--accent);font-weight:700}
  h1{margin:10px 0 6px;font-size:30px}
  p.lead{color:var(--muted);margin:0 0 12px}
  .cta-row{display:flex;gap:10px;align-items:center}
  .small-card{background:var(--card);padding:8px;border-radius:10px;box-shadow:0 6px 22px rgba(12,17,43,0.04);display:inline-block;margin-right:8px}
  /* finder / map */
  .map-wrap{height:520px;border-radius:12px;overflow:hidden;border:1px solid #eef3f7}
  #map{height:100%;width:100%}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px}
  .chip{padding:8px 12px;border-radius:999px;background:#fff;border:1px solid #f0f3f8;font-weight:700;cursor:pointer}
  /* right column / cards */
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ef;font-size:14px}
  textarea{min-height:80px;resize:vertical}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .history-item{padding:10px;border-radius:8px;border:1px dashed #eef2f7;margin-bottom:8px;background:linear-gradient(180deg,#fff,#fbfdff)}
  /* leaderboard fancy */
  .leaderboard{display:grid;grid-template-columns:1fr 260px;gap:14px;align-items:start}
  .leaderboard-card{padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fffbf9);box-shadow:0 14px 40px rgba(255,111,97,0.06)}
  .player{display:flex;gap:12px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.6);margin-bottom:8px}
  .avatar{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
  .medal{width:42px;height:42px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
  .progress{height:8px;background:#f1f5f9;border-radius:6px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:50%}
  /* footer & small utilities */
  footer{padding:18px 0;color:var(--muted);font-size:13px;text-align:center}
  .floating{position:fixed;right:18px;bottom:22px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;padding:12px 16px;border-radius:28px;font-weight:700;box-shadow:0 14px 40px rgba(12,17,43,0.14);z-index:1200;display:flex;gap:10px;align-items:center;cursor:pointer}
  .floating:active{transform:scale(.98)}
  /* responsive */
  @media (max-width:1000px){ .hero{grid-template-columns:1fr;gap:12px} .leaderboard{grid-template-columns:1fr} .map-wrap{height:360px} }
  @media (max-width:520px){ .container{padding:10px} h1{font-size:22px} .map-wrap{height:260px} .floating{right:12px;bottom:12px} .navlinks{display:none} }
  /* small animations */
  .fade-in{opacity:0;transform:translateY(6px);animation:fadeInUp .6s forwards}
  @keyframes fadeInUp{to{opacity:1;transform:none}}
  .mini{font-size:13px;color:var(--muted)}
  button:focus{outline:3px solid rgba(43,108,255,0.12);outline-offset:3px}
</style>
</head>
<body>

<!-- Top nav -->
<header class="topnav" role="navigation">
  <div class="brand" aria-hidden="false">
    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" style="border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));padding:6px">
      <path d="M6 14l4-4 4 4 4-8" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    HungerHero
  </div>

  <nav class="navlinks" aria-label="Main navigation">
    <a href="#home" class="navlink active">Home</a>
    <a href="#finder" class="navlink">Finder</a>
    <a href="#ngo" class="navlink">NGO Register</a>
    <a href="#volunteers" class="navlink">Volunteers</a>
    <a href="#leaderboard" class="navlink">Leaderboard</a>
    <a href="#about" class="navlink">About</a>
    <a href="#contact" class="navlink">Contact</a>
  </nav>

  <div class="nav-right">
    <button id="quickDonate" class="btn">Donate</button>
  </div>
</header>

<div class="container">

  <!-- HOME -->
  <section id="home" class="fade-in">
    <div class="hero" role="region" aria-labelledby="home-title">
      <div>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="badge">Hunger Hero • UAE</div>
          <div class="mini" style="margin-left:auto">Mobile-ready • Find & Donate</div>
        </div>
        <h1 id="home-title">End Hunger. Share Hope.</h1>
        <p class="lead">Find local food banks across all 7 emirates, arrange pickups, and join volunteers. This platform helps match donations with charity partners quickly and safely.</p>

        <div class="cta-row">
          <button id="goFinder" class="btn">Find Food Banks</button>
          <button id="goDonate" class="btn-ghost">Donate Now</button>

          <div style="margin-left:auto;text-align:right">
            <div class="mini">Impact this month</div>
            <div style="font-weight:900;font-size:20px">15,248 meals</div>
          </div>
        </div>

        <div class="controls" style="margin-top:14px">
          <div class="small-card"><strong>Pickup</strong><div class="mini">We help arrange pickups</div></div>
          <div class="small-card"><strong>Volunteers</strong><div class="mini">Join our mission</div></div>
          <div class="small-card"><strong>Secure</strong><div class="mini">Protected submissions</div></div>
        </div>

        <!-- quick summary / mission -->
        <div style="margin-top:14px" class="card">
          <strong>How it works</strong>
          <ol style="margin:8px 0 0 18px;color:var(--muted)">
            <li>Find the nearest food bank using the Finder.</li>
            <li>Submit donation details via Donate form.</li>
            <li>NGOs and volunteers get notified and arrange collection.</li>
          </ol>
        </div>
      </div>

      <!-- right column: donate card -->
      <div>
        <div class="card" id="donationCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:900">Donate — Pickup Request</div>
            <div class="mini">Saves to Supabase</div>
          </div>

          <form id="donateForm" style="margin-top:12px">
            <div class="row" style="margin-bottom:8px">
              <div class="col">
                <label for="name">Name</label>
                <input id="name" required placeholder="Your name" />
              </div>
              <div style="width:140px">
                <label for="phone">Phone</label>
                <input id="phone" placeholder="+971..." />
              </div>
            </div>

            <div class="row" style="margin-bottom:8px">
              <div class="col">
                <label for="date">Date</label>
                <input id="date" type="date" />
              </div>
              <div style="width:120px">
                <label for="time">Time</label>
                <input id="time" type="time" />
              </div>
            </div>

            <div style="margin-bottom:8px">
              <label for="quantity">Quantity (boxes / meals / kg)</label>
              <input id="quantity" placeholder="e.g. 5 boxes" />
            </div>

            <div style="margin-bottom:8px">
              <label for="notes">Notes</label>
              <textarea id="notes" placeholder="Pickup instructions, dietary info..."></textarea>
            </div>

            <input type="hidden" id="lat" />
            <input type="hidden" id="lng" />

            <div style="display:flex;gap:8px;align-items:center">
              <button type="submit" class="btn">Send donation</button>
              <button id="saveLocal" type="button" class="btn-ghost">Save locally</button>
              <div style="margin-left:auto;text-align:right">
                <div class="mini">Local saved</div>
                <div id="localCount" style="font-weight:700">0</div>
              </div>
            </div>
          </form>

          <div style="margin-top:12px">
            <div style="font-weight:800">Why HungerHero?</div>
            <div class="mini" style="margin-top:6px">We connect donors, volunteers and NGOs across the UAE to reduce food waste and feed families in need.</div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- FINDER -->
  <section id="finder" class="fade-in" aria-labelledby="finder-title">
    <h2 id="finder-title">Finder — Map</h2>
    <p class="mini">Filter by emirate or food type. Click a marker for details and request pickup.</p>

    <div style="display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:12px">
      <div>
        <div style="display:flex;gap:10px;align-items:center">
          <select id="emirate" aria-label="Filter by emirate">
            <option value="all">All Emirate</option>
            <option>Abu Dhabi</option><option>Dubai</option><option>Sharjah</option>
            <option>Ajman</option><option>Umm Al Quwain</option><option>Ras Al Khaimah</option><option>Fujairah</option>
          </select>

          <select id="foodtype" aria-label="Filter by food type">
            <option value="all">All types</option><option>Cooked</option><option>Packaged</option><option>Canned</option>
          </select>

          <button id="findMe" class="btn-ghost">Find Near Me</button>
          <div style="margin-left:auto" class="mini">Tap a marker → Request pickup</div>
        </div>

        <div class="map-wrap" style="margin-top:10px">
          <div id="map"></div>
        </div>

      </div>

      <aside>
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Nearby centers</div>
            <div class="mini">Tap a marker to route</div>
          </div>
          <div id="nearbyList" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <div style="font-weight:800">Quick actions</div>
          <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
            <button id="centerUAE" class="chip">Center UAE</button>
            <button id="showAll" class="chip">Show all</button>
            <button id="routeFirst" class="chip">Route to nearest</button>
          </div>
        </div>
      </aside>
    </div>
  </section>

  <!-- NGO Registration -->
  <section id="ngo" class="fade-in">
    <h2>NGO Registration</h2>
    <p class="mini">Register your NGO so donors and volunteers can find you. This form goes to our Supabase backend.</p>

    <div style="display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:12px">
      <div class="card">
        <strong>Register your NGO</strong>
        <p class="mini" style="margin-top:8px">Enter details and we will contact you to verify your organization.</p>

        <form id="ngoForm" style="margin-top:10px">
          <label>NGO name</label><input id="ngo_name" placeholder="e.g. Food Bank Abu Dhabi" required />
          <div class="row" style="margin-top:8px">
            <div class="col"><label>Emirate</label><select id="ngo_emirate"><option>Abu Dhabi</option><option>Dubai</option><option>Sharjah</option><option>Ajman</option><option>Umm Al Quwain</option><option>Ras Al Khaimah</option><option>Fujairah</option></select></div>
            <div style="width:140px"><label>Phone</label><input id="ngo_phone" placeholder="+971..." /></div>
          </div>
          <label style="margin-top:8px">Food types accepted</label>
          <select id="ngo_type"><option>Cooked</option><option>Packaged</option><option>Canned</option></select>
          <label style="margin-top:8px">Notes</label>
          <textarea id="ngo_notes"></textarea>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="ngoSubmit" type="button" class="btn">Register NGO</button>
            <button id="ngoFormSaveLocal" type="button" class="btn-ghost">Save locally</button>
          </div>
        </form>
      </div>

      <div class="card">
        <div style="font-weight:800">Info</div>
        <div class="mini" style="margin-top:8px">Using Supabase as backend for registrations.</div>
      </div>
    </div>
  </section>

  <!-- Volunteers -->
  <section id="volunteers" class="fade-in">
    <h2>Volunteers</h2>
    <p class="mini">Join our volunteer network — help with pickups, sorting or community outreach.</p>

    <div style="display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:12px">
      <div class="card">
        <form id="volForm">
          <label>Name</label><input id="vol_name" placeholder="Your full name" required />
          <label style="margin-top:8px">Email</label><input id="vol_email" placeholder="you@example.com" />
          <div class="row" style="margin-top:8px">
            <div class="col"><label>Emirate</label><select id="vol_emirate"><option>Abu Dhabi</option><option>Dubai</option><option>Sharjah</option><option>Ajman</option><option>Umm Al Quwain</option><option>Ras Al Khaimah</option><option>Fujairah</option></select></div>
            <div style="width:140px"><label>Phone</label><input id="vol_phone" placeholder="+971..." /></div>
          </div>
          <label style="margin-top:8px">Availability / skills</label><textarea id="vol_notes" placeholder="Weekends, sorting, driving..."></textarea>
          <div style="display:flex;gap:8px;margin-top:10px"><button id="volSubmit" class="btn">Sign up</button><button id="volSaveLocal" class="btn-ghost">Save locally</button></div>
        </form>
      </div>

      <div class="card">
        <div style="font-weight:800">Info</div>
        <div class="mini" style="margin-top:8px">Using Supabase for volunteer signups.</div>
      </div>
    </div>
  </section>

  <!-- LEADERBOARD (fancy placeholder) -->
  <section id="leaderboard" class="fade-in">
    <h2>Leaderboard</h2>
    <p class="mini">Top donors & volunteers — placeholder data for now.</p>

    <div class="leaderboard" style="margin-top:12px">
      <div class="leaderboard-card card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Top donors</div>
          <div class="mini">Updated weekly</div>
        </div>

        <div style="margin-top:12px">
          <div class="player">
            <div style="display:flex;gap:8px;align-items:center">
              <div class="avatar" style="background:linear-gradient(135deg,#ffd166,#ff6b6b);width:56px;height:56px;border-radius:12px">A</div>
              <div>
                <div style="font-weight:800">Ahmed</div>
                <div class="mini">12 donations • 240 meals</div>
              </div>
            </div>
            <div style="margin-left:auto;text-align:right">
              <div class="medal" style="background:linear-gradient(135deg,#f6d365,#fda085)">🥇</div>
            </div>
          </div>

          <div class="player">
            <div style="display:flex;gap:8px;align-items:center">
              <div class="avatar" style="background:linear-gradient(135deg,#cfe9ff,#6fb1ff);width:52px;height:52px;border-radius:12px">S</div>
              <div>
                <div style="font-weight:800">Sara</div>
                <div class="mini">9 donations • 180 meals</div>
              </div>
            </div>
            <div style="margin-left:auto;text-align:right">
              <div class="medal" style="background:linear-gradient(135deg,#d4d4d8,#9b9bff)">🥈</div>
            </div>
          </div>

          <div class="player">
            <div style="display:flex;gap:8px;align-items:center">
              <div class="avatar" style="background:linear-gradient(135deg,#c1ffd7,#7ee8b6);width:48px;height:48px;border-radius:12px">R</div>
              <div>
                <div style="font-weight:800">Rashid</div>
                <div class="mini">6 donations • 120 meals</div>
              </div>
            </div>
            <div style="margin-left:auto;text-align:right">
              <div class="medal" style="background:linear-gradient(135deg,#ffd7a6,#ffb2a6)">🥉</div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700">Community progress</div>
          <div class="mini" style="margin-top:6px">This month: goal 20,000 meals</div>
          <div style="margin-top:8px" class="progress"><i style="width:62%"></i></div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900">Volunteer spotlight</div>
        <div style="margin-top:10px">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <div style="font-weight:800">Fatima</div><div class="mini">• 42 hours</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div style="width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,#ffb2a6,#ff6b6b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900">F</div>
            <div>
              <div style="font-weight:800">Iconic volunteer</div>
              <div class="mini">Driver & logistic support</div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700">More features coming</div>
          <div class="mini" style="margin-top:6px">Admin leaderboard, verified donors & badges soon.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ABOUT -->
  <section id="about" class="fade-in">
    <h2>About HungerHero</h2>
    <p class="mini" style="max-width:900px">
      HungerHero is a community-driven platform that connects donors, NGOs and volunteers across the UAE to reduce food waste and support families in need. We focus on fast coordination, clear pickup logistics and secure handling of donor information. Our goal is to make local giving easy and trustworthy.
    </p>

    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
      <div class="card" style="width:280px">
        <div style="font-weight:800">Mission</div>
        <div class="mini" style="margin-top:6px">Reduce food waste; feed communities; empower volunteers.</div>
      </div>
      <div class="card" style="width:280px">
        <div style="font-weight:800">Partners</div>
        <div class="mini" style="margin-top:6px">Government & NGO partners across the 7 emirates (sample partners listed on site).</div>
      </div>
      <div class="card" style="width:280px">
        <div style="font-weight:800">Safety</div>
        <div class="mini" style="margin-top:6px">We recommend verifying NGOs; sensitive data is stored in your Supabase project.</div>
      </div>
    </div>
  </section>

  <!-- CONTACT -->
  <section id="contact" class="fade-in">
    <h2>Contact</h2>
    <p class="mini">Questions or feedback? Use the form below.</p>

    <div style="display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:12px">
      <div class="card">
        <form id="contactForm">
          <label>Name</label><input id="contact_name" placeholder="Your name" />
          <label style="margin-top:8px">Email or phone</label><input id="contact_phone" placeholder="you@example.com / +971..." />
          <label style="margin-top:8px">Message</label><textarea id="contact_msg"></textarea>
          <div style="display:flex;gap:8px;margin-top:10px"><button id="contactSend" class="btn">Send</button><button id="contactSaveLocal" class="btn-ghost">Save locally</button></div>
        </form>
      </div>
      <div class="card">
        <div style="font-weight:800">Contact info</div>
        <div class="mini" style="margin-top:8px">Email: support@hungerhero.ae (placeholder)</div>
        <div class="mini" style="margin-top:6px">WhatsApp: +971XXXXXXXXX</div>
        <div style="margin-top:12px">
          <div style="font-weight:700">Social</div>
          <div style="display:flex;gap:8px;margin-top:8px"><div class="chip">Instagram</div><div class="chip">Facebook</div><div class="chip">Twitter</div></div>
        </div>
      </div>
    </div>
  </section>

  <footer>© HungerHero — Demo • Replace placeholders with your actual Supabase anon key and adjust table/column names if needed.</footer>
</div>

<div class="floating" id="fabDonate" tabindex="0">Donate</div>

<!-- Supabase + App logic -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  /* ---------------- CONFIG: Supabase ---------------- */
  const SUPABASE_URL = 'https://wgxgvmphxxrjxlitzfoy.supabase.co';
  const SUPABASE_ANON_KEY = 'anon-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndneGd2bXBoeHhyanhsaXR6Zm95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjMxMjIsImV4cCI6MjA3NjYzOTEyMn0.Y1YZCTUUiuLFW9q5f7SywjnlYtWH_vAEtQW8iXbF9sQ';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ---------- Map & Centers ---------- */
  const centers = [
    {name:'Food Bank Abu Dhabi', emirate:'Abu Dhabi', area:'Corniche Rd', type:'Canned', lat:24.4769, lng:54.3656},
    {name:'Abu Dhabi Charity Center', emirate:'Abu Dhabi', area:'Al Khalidiya', type:'Cooked', lat:24.4666, lng:54.3610},
    {name:'Hope Center Abu Dhabi', emirate:'Abu Dhabi', area:'Mussafah', type:'Packaged', lat:24.3210, lng:54.4370},
    {name:'Helping Hands Dubai', emirate:'Dubai', area:'Al Barsha 1', type:'Cooked', lat:25.1190, lng:55.1900},
    {name:'Share the Love Dubai', emirate:'Dubai', area:'Downtown Dubai', type:'Packaged', lat:25.1972, lng:55.2744},
    {name:'Dubai Food Relief', emirate:'Dubai', area:'Deira', type:'Canned', lat:25.2637, lng:55.3092},
    {name:'Care4U Sharjah', emirate:'Sharjah', area:'Al Majaz', type:'Packaged', lat:25.3546, lng:55.3811},
    {name:'Sharjah Food Bank', emirate:'Sharjah', area:'Industrial Area', type:'Cooked', lat:25.3170, lng:55.3977},
    {name:'Ajman Charity Center', emirate:'Ajman', area:'Ajman Corniche', type:'Canned', lat:25.4040, lng:55.4810},
    {name:'Ajman Helping Hands', emirate:'Ajman', area:'Al Jurf', type:'Packaged', lat:25.3990, lng:55.4690},
    {name:'UAQ Food Relief', emirate:'Umm Al Quwain', area:'UAQ Main St', type:'Cooked', lat:25.5645, lng:55.5479},
    {name:'UAQ Charity Center', emirate:'Umm Al Quwain', area:'Al Raas', type:'Canned', lat:25.5860, lng:55.5460},
    {name:'RAK Food Aid', emirate:'Ras Al Khaimah', area:'RAK City Center', type:'Packaged', lat:25.7890, lng:55.9430},
    {name:'RAK Charity Hub', emirate:'Ras Al Khaimah', area:'Al Nakheel', type:'Cooked', lat:25.7320, lng:55.9120},
    {name:'Fujairah Helping Hands', emirate:'Fujairah', area:'Fujairah Port', type:'Canned', lat:25.1278, lng:56.3269},
    {name:'Fujairah Food Relief', emirate:'Fujairah', area:'Central Market', type:'Packaged', lat:25.1230, lng:56.3260}
  ];

  /* Leaflet init */
  const map = L.map('map', {zoomControl:true, preferCanvas:true}).setView([24.4539,54.3773], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap contributors'}).addTo(map);
  const markerLayer = L.layerGroup().addTo(map);
  let lastPolyline = null;

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
  function toRad(v){return v*Math.PI/180}
  function haversine(lat1,lon1,lat2,lon2){
    const R=6371; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c;
  }

  function createPopupHtml(c){
    return `<div style="min-width:200px">
      <strong>${escapeHtml(c.name)}</strong>
      <div class="mini">${escapeHtml(c.area)} — ${escapeHtml(c.emirate)}</div>
      <div style="margin-top:8px;font-weight:800">${escapeHtml(c.type)}</div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn-popup" data-name="${escapeHtml(c.name)}">Request pickup</button>
        <button class="btn-route" data-lat="${c.lat}" data-lng="${c.lng}">Route from me</button>
      </div>
    </div>`;
  }
  function addMarkers(list){
    markerLayer.clearLayers();
    list.forEach(c => {
      const m = L.marker([c.lat,c.lng], {riseOnHover:true}).addTo(markerLayer);
      m.bindPopup(createPopupHtml(c), {closeButton:true});
      m.on('popupopen', () => {
        setTimeout(()=>{ // attach handlers after popup DOM ready
          document.querySelectorAll('.btn-popup').forEach(btn=> btn.onclick = ()=> {
            document.getElementById('donationCard').scrollIntoView({behavior:'smooth',block:'center'});
          });
          document.querySelectorAll('.btn-route').forEach(btn=> btn.onclick = (ev)=> {
            const lat = parseFloat(btn.getAttribute('data-lat')), lng = parseFloat(btn.getAttribute('data-lng'));
            if (window._lastUserPos) { drawRoute(window._lastUserPos, {lat,lng}); map.setView([lat,lng],13); }
            else alert('Grant location permission first (use Find Near Me)');
          });
        },10);
      });
    });
  }
  addMarkers(centers);

  (function fitInitial(){
    const bounds = L.latLngBounds(centers.map(c => [c.lat, c.lng]));
    map.fitBounds(bounds.pad(0.2));
  })();

  document.getElementById('emirate').addEventListener('change', applyFilters);
  document.getElementById('foodtype').addEventListener('change', applyFilters);
  function applyFilters(){
    const e = document.getElementById('emirate').value;
    const t = document.getElementById('foodtype').value;
    const filtered = centers.filter(c => (e==='all' || c.emirate===e) && (t==='all' || c.type===t));
    addMarkers(filtered);
    renderNearbyList(filtered);
    if (filtered.length) {
      const bounds = L.latLngBounds(filtered.map(f => [f.lat,f.lng]));
      map.fitBounds(bounds.pad(0.25), {animate:true});
    }
  }

  function renderNearbyList(list){
    const el = document.getElementById('nearbyList');
    if (!list.length) { el.innerHTML = '<div class="mini">No centers found</div>'; return; }
    el.innerHTML = list.slice(0,8).map(c => `<div style="padding:8px;border-radius:8px;border:1px solid #f1f5f9;margin-bottom:8px">
      <strong>${escapeHtml(c.name)}</strong><div class="mini">${escapeHtml(c.area)} • ${escapeHtml(c.type)}</div>
      <div style="margin-top:6px"><button class="chip" data-lat="${c.lat}" data-lng="${c.lng}">Route</button></div>
    </div>`).join('');
    el.querySelectorAll('.chip').forEach(btn => btn.onclick = ()=> {
      const lat = parseFloat(btn.getAttribute('data-lat')), lng = parseFloat(btn.getAttribute('data-lng'));
      if (window._lastUserPos) drawRoute(window._lastUserPos, {lat,lng});
      map.setView([lat,lng],13);
    });
  }

  document.getElementById('findMe').addEventListener('click', ()=> {
    if (!navigator.geolocation) return alert('Geolocation not supported');
    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      document.getElementById('lat').value = lat; document.getElementById('lng').value = lng;
      if (window._userMarker) map.removeLayer(window._userMarker);
      window._userMarker = L.circleMarker([lat,lng], {radius:8, color:'#2b6cff', fill:true}).addTo(map).bindPopup('You are here').openPopup();
      window._lastUserPos = {lat,lng};
      const nearest = findNearest(lat,lng);
      if (nearest) {
        map.setView([nearest.lat, nearest.lng], 13);
        markerLayer.eachLayer(l=>{
          const ll = l.getLatLng();
          if (Math.abs(ll.lat - nearest.lat) < 0.0001 && Math.abs(ll.lng - nearest.lng) < 0.0001) l.openPopup();
        });
        drawRoute({lat,lng},{lat:nearest.lat,lng:nearest.lng});
        alert(`Nearest: ${nearest.name} — ${nearest.area} (${nearest.type}), ${nearest.d.toFixed(1)} km`);
      }
    }, err => alert('Unable to get location: ' + err.message), {enableHighAccuracy:true,timeout:12000});
  });

  document.getElementById('centerUAE').addEventListener('click', ()=> {
    map.setView([24.4539,54.3773], 9);
  });
  document.getElementById('showAll').addEventListener('click', ()=> { addMarkers(centers); (function(){ const bounds = L.latLngBounds(centers.map(c => [c.lat,c.lng])); map.fitBounds(bounds.pad(0.2)); })(); });
  document.getElementById('routeFirst').addEventListener('click', ()=> {
    if (window._lastUserPos) { const n = findNearest(window._lastUserPos.lat, window._lastUserPos.lng); if (n) drawRoute(window._lastUserPos,{lat:n.lat,lng:n.lng}); }
    else alert('Use Find Near Me first');
  });

  function findNearest(lat,lng){
    let minD = Infinity, nearest = null;
    centers.forEach(c => { const d = haversine(lat,lng,c.lat,c.lng); if (d < minD) { minD = d; nearest = {...c, d}; } });
    return nearest;
  }

  function drawRoute(a,b){
    if (lastPolyline) map.removeLayer(lastPolyline);
    lastPolyline = L.polyline([[a.lat,a.lng],[b.lat,b.lng]], {dashArray:'6 8', color:'#ff6b61', weight:3}).addTo(map);
    const start = L.circleMarker([a.lat,a.lng], {radius:6, color:'#2b6cff'}).addTo(map);
    const end = L.circleMarker([b.lat,b.lng], {radius:6, color:'#ff6b61'}).addTo(map);
    setTimeout(()=>{ try{ map.removeLayer(start); map.removeLayer(end); }catch(e){} },7000);
  }

  /* ---------- Local history helpers ---------- */
  const HISTORY_KEY = 'hh_v2_history';
  function loadHistory(){ try{ const raw = localStorage.getItem(HISTORY_KEY); return raw? JSON.parse(raw):[] } catch(e){ return []; } }
  function saveHistory(list){ localStorage.setItem(HISTORY_KEY, JSON.stringify(list)); renderHistory(); }
  function renderHistory(){ const list = loadHistory(); const c = document.getElementById('localCount'); if(c) c.innerText = list.length; }

  /* ---------- Supabase insert helper ---------- */
  async function insertRow(table, payload) {
    if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_ANON_KEY_HERE') {
      console.warn('Supabase anon key not configured; data saved locally only.');
      return { data: null, error: { message: 'Supabase anon key not configured. Save locally only.' }, localOnly: true };
    }
    const { data, error } = await supabase.from(table).insert([payload]);
    return { data, error, localOnly: false };
  }

  /* ---------- Donation form submit (Supabase) ---------- */
  const donateForm = document.getElementById('donateForm');
  donateForm.addEventListener('submit', async (ev)=> {
    ev.preventDefault();
    const payload = {
      name: document.getElementById('name').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      date: document.getElementById('date').value || null,
      time: document.getElementById('time').value || null,
      quantity: document.getElementById('quantity').value.trim(),
      notes: document.getElementById('notes').value.trim(),
      lat: document.getElementById('lat').value ? parseFloat(document.getElementById('lat').value) : null,
      lng: document.getElementById('lng').value ? parseFloat(document.getElementById('lng').value) : null,
      ts: new Date().toISOString()
    };
    if (!payload.name) return alert('Please enter your name');

    // save locally always (quick offline fallback)
    const hist = loadHistory(); hist.unshift(payload); if (hist.length>30) hist.pop(); saveHistory(hist);

    // try Supabase insert
    const btn = donateForm.querySelector('button[type="submit"]');
    btn.disabled = true; btn.innerText = 'Sending...';
    try {
      const res = await insertRow('donations', payload);
      if (res.localOnly) {
        alert('Saved locally. Configure your Supabase anon key to persist remotely.');
        donateForm.reset();
      } else if (res.error) {
        console.error('Supabase error:', res.error);
        alert('❌ Error saving — saved locally. ' + (res.error.message || ''));
      } else {
        alert('✅ Donation saved. Thank you!');
        donateForm.reset();
      }
    } catch (err) {
      console.error(err);
      alert('Network error — saved locally.');
    } finally {
      btn.disabled = false; btn.innerText = 'Send donation';
    }
  });

  /* Save locally button for donation */
  document.getElementById('saveLocal').addEventListener('click', ()=> {
    const payload = {
      name: document.getElementById('name').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      date: document.getElementById('date').value,
      time: document.getElementById('time').value,
      quantity: document.getElementById('quantity').value.trim(),
      notes: document.getElementById('notes').value.trim(),
      ts: new Date().toISOString()
    };
    const hist = loadHistory(); hist.unshift(payload); if (hist.length>30) hist.pop(); saveHistory(hist);
    alert('Saved locally.');
  });
  renderHistory(); // init

  /* ---------- NGO form (Supabase) ---------- */
  document.getElementById('ngoSubmit').addEventListener('click', async ()=> {
    const payload = {
      name: document.getElementById('ngo_name').value.trim(),
      emirate: document.getElementById('ngo_emirate').value,
      phone: document.getElementById('ngo_phone').value.trim(),
      type: document.getElementById('ngo_type').value,
      notes: document.getElementById('ngo_notes').value.trim(),
      ts: new Date().toISOString()
    };
    if (!payload.name) return alert('Enter NGO name');

    const btn = document.getElementById('ngoSubmit'); btn.disabled = true; btn.innerText = 'Sending...';
    try {
      const res = await insertRow('ngo_registrations', payload);
      if (res.localOnly) {
        localSave('ngo', payload);
        alert('Saved locally. Configure your Supabase anon key to persist remotely.');
        document.getElementById('ngoForm').reset();
      } else if (res.error) {
        console.error(res.error);
        localSave('ngo', payload);
        alert('Saved locally but server failed.');
      } else {
        alert('NGO registration submitted. Thank you!');
        document.getElementById('ngoForm').reset();
      }
    } catch (e) {
      console.warn(e);
      localSave('ngo', payload);
      alert('Network error — saved locally.');
    } finally { btn.disabled = false; btn.innerText = 'Register NGO'; }
  });

  document.getElementById('ngoFormSaveLocal').addEventListener('click', ()=> {
    const payload = { name: document.getElementById('ngo_name').value.trim(), emirate: document.getElementById('ngo_emirate').value, phone: document.getElementById('ngo_phone').value, type: document.getElementById('ngo_type').value, notes: document.getElementById('ngo_notes').value, ts: new Date().toISOString() };
    localSave('ngo', payload);
    alert('Saved locally');
  });

  /* ---------- Volunteers (Supabase) ---------- */
  document.getElementById('volSubmit').addEventListener('click', async (ev)=> {
    ev.preventDefault();
    const payload = {
      name: document.getElementById('vol_name').value.trim(),
      email: document.getElementById('vol_email').value.trim(),
      emirate: document.getElementById('vol_emirate').value,
      phone: document.getElementById('vol_phone').value.trim(),
      notes: document.getElementById('vol_notes').value.trim(),
      ts: new Date().toISOString()
    };
    if (!payload.name) return alert('Enter your name');

    const btn = document.getElementById('volSubmit'); btn.disabled = true; btn.innerText = 'Sending...';
    try {
      const res = await insertRow('volunteers', payload);
      if (res.localOnly) {
        localSave('volunteer', payload);
        alert('Saved locally. Configure your Supabase anon key to persist remotely.');
        document.getElementById('volForm').reset();
      } else if (res.error) {
        console.error(res.error);
        localSave('volunteer', payload);
        alert('Saved locally but server failed.');
      } else {
        alert('Volunteer signup submitted — thank you!');
        document.getElementById('volForm').reset();
      }
    } catch (e) {
      console.warn(e);
      localSave('volunteer', payload);
      alert('Network error — saved locally.');
    } finally { btn.disabled = false; btn.innerText = 'Sign up'; }
  });

  document.getElementById('volSaveLocal').addEventListener('click', ()=> {
    const payload = { name: document.getElementById('vol_name').value.trim(), email: document.getElementById('vol_email').value.trim(), emirate: document.getElementById('vol_emirate').value, phone: document.getElementById('vol_phone').value.trim(), notes: document.getElementById('vol_notes').value.trim(), ts: new Date().toISOString() };
    localSave('volunteer', payload);
    alert('Saved locally');
  });

  /* ---------- Contact (Supabase) ---------- */
  document.getElementById('contactSend').addEventListener('click', async (ev)=> {
    ev.preventDefault();
    const payload = {
      name: document.getElementById('contact_name').value.trim(),
      contact: document.getElementById('contact_phone').value.trim(),
      message: document.getElementById('contact_msg').value.trim(),
      ts: new Date().toISOString()
    };
    if (!payload.contact && !payload.name) return alert('Please provide name or contact info');

    const btn = document.getElementById('contactSend'); btn.disabled = true; btn.innerText = 'Sending...';
    try {
      const res = await insertRow('contact_messages', payload);
      if (res.localOnly) {
        localSave('contact', payload);
        alert('Saved locally. Configure your Supabase anon key to persist remotely.');
        document.getElementById('contactForm').reset();
      } else if (res.error) {
        console.error(res.error);
        localSave('contact', payload);
        alert('Saved locally but server failed.');
      } else {
        alert('Message sent — thank you!');
        document.getElementById('contactForm').reset();
      }
    } catch (e) {
      console.warn(e);
      localSave('contact', payload);
      alert('Network error — saved locally.');
    } finally { btn.disabled = false; btn.innerText = 'Send'; }
  });

  document.getElementById('contactSaveLocal').addEventListener('click', ()=> {
    const payload = { name: document.getElementById('contact_name').value.trim(), contact: document.getElementById('contact_phone').value.trim(), message: document.getElementById('contact_msg').value.trim(), ts: new Date().toISOString() };
    localSave('contact', payload);
    alert('Saved locally');
  });

  /* ---------- localSave util (fallback) ---------- */
  function localSave(kind, payload){
    const key = 'hh_v2_' + (kind || 'misc');
    try {
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.unshift(payload);
      if (arr.length>50) arr.pop();
      localStorage.setItem(key, JSON.stringify(arr));
    } catch(e){ console.warn('localSave failed',e); }
  }

  /* floating donate & quick links */
  document.getElementById('fabDonate').addEventListener('click', ()=> { document.getElementById('donationCard').scrollIntoView({behavior:'smooth', block:'center'}); });
  document.getElementById('quickDonate').addEventListener('click', ()=> { document.getElementById('donationCard').scrollIntoView({behavior:'smooth', block:'center'}); });
  document.getElementById('goFinder').addEventListener('click', ()=> { document.getElementById('finder').scrollIntoView({behavior:'smooth'}); });
  document.getElementById('goDonate').addEventListener('click', ()=> { document.getElementById('donationCard').scrollIntoView({behavior:'smooth', block:'center'}); });

  /* nav active highlight on scroll */
  const navLinks = document.querySelectorAll('.navlink');
  const sections = Array.from(document.querySelectorAll('section'));
  function onScroll(){
    const y = window.scrollY + 80;
    let current = sections[0];
    for (const s of sections) if (s.offsetTop <= y) current = s;
    navLinks.forEach(a => a.classList.toggle('active', a.getAttribute('href') === '#' + current.id));
  }
  window.addEventListener('scroll', onScroll);

  /* small startup */
  renderNearbyList(centers);
  applyFilters();
  onScroll();

  /* accessibility: keyboard activation for fab */
  document.getElementById('fabDonate').addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); document.getElementById('donationCard').scrollIntoView({behavior:'smooth', block:'center'}); } });

</script>

</body>
</html>
// diagnostic insertRow — paste over your existing insertRow() implementation
async function insertRow(table, payload) {
  try {
    // quick sanity-check: trim the key string so stray whitespace won't break it
    const keyTrimmed = SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.trim();
    if (!keyTrimmed || keyTrimmed === 'YOUR_ANON_KEY_HERE') {
      console.warn('Supabase anon key not set (or placeholder).');
      return { data: null, error: { message: 'Anon key missing' }, localOnly: true };
    }

    // use supabase client as before
    const res = await supabase.from(table).insert([payload]);

    // If Supabase client returned an error object, log everything
    if (res.error) {
      console.error('Supabase returned error object:', res.error);
      // Try to fetch the raw REST response for extra details (useful to see 401 body)
      try {
        const restUrl = `${SUPABASE_URL.replace(/^https?:\/\//,'')}/rest/v1/${encodeURIComponent(table)}?limit=1`;
        // Note: This fetch is only to surface raw response headers & body for diagnostics
        const raw = await fetch(`https://${restUrl}`, {
          method: 'GET',
          headers: { apikey: keyTrimmed, Authorization: 'Bearer ' + keyTrimmed }
        }).catch(e => ({ error: e }));
        console.log('Raw REST test response (may surface 401 details):', raw);
      } catch (e) {
        console.warn('Raw REST fetch failed (maybe CORS):', e);
      }
      return { data: null, error: res.error, localOnly: false };
    }

    // success
    return { data: res.data, error: null, localOnly: false };
  } catch (err) {
    console.error('insertRow unexpected error:', err);
    return { data: null, error: err, localOnly: false };
  }
}

