
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HungerHero — Donate & Find Food Banks</title>
  <meta name="theme-color" content="#071127" />
  <style>
  /*
    HungerHero - single-file SPA (full code with theme fix)
    - theme toggling works by setting data-theme on <html>
    - CSS variables change under [data-theme="light"]
    - All features from previous versions included (map lazy load, admin demo, service worker blob, toasts, forms)
  */

  :root{
    /* dark theme defaults */
    --panel: linear-gradient(180deg,#071127 0%, #04101a 100%);
    --bg: #071127;
    --card-bg: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    --modal-bg: linear-gradient(180deg,#071427,#061022);
    --text: #e6eef6;
    --muted: #9aa6b2;
    --accent: #ff7a59;
    --accent-2: #ffb48f;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
    --radius:14px;
    --shadow: 0 20px 50px rgba(2,6,23,0.6);
    --success: #6fda8a;
    --danger: #ff6b6b;
    --max-width: 1200px;
    --ease: cubic-bezier(.2,.9,.3,1);
    color-scheme: dark;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  /* Light theme overrides when data-theme="light" is set on the root element */
  :root[data-theme="light"], [data-theme="light"] {
    --panel: linear-gradient(180deg,#f7fafc 0%, #eef2f7 100%);
    --bg: #f7fafc;
    --card-bg: linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.01));
    --modal-bg: linear-gradient(180deg,#ffffff,#f6f9fc);
    --text: #071127;
    --muted: #51606a;
    --glass: rgba(0,0,0,0.04);
    --glass-2: rgba(0,0,0,0.02);
    --shadow: 0 12px 30px rgba(2,6,23,0.08);
    color-scheme: light;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--panel);color:var(--text);-webkit-font-smoothing:antialiased}
  a{color:inherit;text-decoration:none}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  /* Top nav */
  .topnav{position:fixed;left:0;right:0;top:0;height:70px;display:flex;align-items:center;padding:10px 18px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter: blur(6px);z-index:9999;gap:12px}
  .brand{display:flex;gap:12px;align-items:center;font-weight:900;font-size:18px}
  .logo{width:44px;height:44px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#071127;font-weight:900}
  .navlinks{margin-left:20px;display:flex;gap:10px;flex-wrap:wrap}
  .navlinks a{padding:8px 10px;border-radius:12px;color:var(--muted);font-weight:700}
  .navlinks a.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#071127}
  .nav-right{margin-left:auto;display:flex;gap:10px;align-items:center}

  .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#071127;padding:10px 14px;border-radius:12px;border:0;font-weight:800;cursor:pointer;box-shadow:0 10px 30px rgba(255,122,89,0.12);transition:transform .12s var(--ease)}
  .btn:active{transform:translateY(1px)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;cursor:pointer;color:var(--muted)}
  .chip{padding:6px 10px;border-radius:999px;background:var(--glass);font-weight:700;color:var(--muted);display:inline-flex;align-items:center;gap:8px}

  /* container */
  .container{max-width:var(--max-width);margin:calc(70px + 20px) auto;padding:18px;transition:opacity .18s var(--ease)}

  /* hero */
  .hero{display:grid;grid-template-columns:1fr 420px;gap:22px;align-items:start}
  h1{margin:6px 0;font-size:28px}
  p.lead{color:var(--muted);margin:0 0 12px;max-width:54ch}

  /* card */
  .card{background:var(--card-bg);border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.02)}
  .small{color:var(--muted);font-size:13px}
  .stats-grid{display:flex;gap:12px;margin-top:12px}
  .stat{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));flex:1}

  /* map & finder */
  .map-wrap{height:520px;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,0.02);transition:box-shadow .15s}
  #map{height:100%;width:100%}
  .controls{display:flex;gap:8px;align-items:center}
  select, input.filters{padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;min-width:140px}

  /* action buttons */
  .action-button{margin-top:6px;background:transparent;border-radius:10px;padding:10px 12px;border:2px solid rgba(255,255,255,0.05);color:var(--accent);font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .action-button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#071127;border:0}

  /* featured list */
  .featured-item{display:flex;gap:10px;align-items:center;margin-bottom:10px}
  .featured-item .avatar{width:40px;height:40px;border-radius:8px;background:linear-gradient(90deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#071127}

  /* details */
  .details{position:fixed;right:18px;top:100px;width:360px;max-height:76vh;overflow:auto;padding:14px;border-radius:12px;background:var(--card-bg);border:1px solid rgba(255,255,255,0.02);box-shadow:0 20px 60px rgba(2,6,23,0.7);z-index:2000;transform:translateY(-6px);opacity:0;pointer-events:none;transition:opacity .22s var(--ease), transform .22s var(--ease)}
  .details.open{opacity:1;pointer-events:auto;transform:translateY(0)}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:3000}
  .modal-backdrop.open{display:flex}
  .modal{width:100%;max-width:720px;border-radius:12px;padding:18px;background:var(--modal-bg);border:1px solid rgba(255,255,255,0.02)}
  .form-row{display:flex;gap:8px}
  .field{flex:1;display:flex;flex-direction:column;gap:6px}
  input[type="text"], input[type="tel"], textarea, select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;outline:none}
  textarea{min-height:100px;resize:vertical}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

  /* toasts */
  .toast-wrap{position:fixed;right:18px;bottom:100px;display:flex;flex-direction:column;gap:8px;z-index:4000}
  .toast{background:var(--card-bg);padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,23,0.6);min-width:220px;display:flex;justify-content:space-between;gap:12px;align-items:center}
  .toast.success{border-left:4px solid var(--success)}
  .toast.warn{border-left:4px solid #ffd66b}
  .toast .btn-inline{background:transparent;border:0;color:var(--accent);font-weight:800;cursor:pointer}

  /* floating CTA - REMOVED in DOM: previously used as bottom donate; kept CSS here in case it's reused later */
  .floating{position:fixed;right:18px;bottom:22px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#071127;padding:12px 16px;border-radius:28px;font-weight:800;box-shadow:0 14px 40px rgba(255,122,89,0.12);z-index:1200;display:flex;gap:10px;align-items:center;cursor:pointer}

  /* admin badge */
  .admin-badge{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:8px;background:var(--glass);color:var(--muted);font-weight:800}

  /* responsiveness */
  @media (max-width:1000px){ .hero{grid-template-columns:1fr 1fr} .map-wrap{height:360px} .details{display:none} }
  @media (max-width:700px){ .hero{grid-template-columns:1fr} .map-wrap{height:260px} .navlinks{display:none} .container{padding:12px} .topnav{padding:8px} }

  /* ======== ADDED STYLES ======== */
  .banner-wrap {
    max-width: 1200px;
    margin: 0 auto 18px;
    padding: 10px 18px;
  }
  .banner-wrap img {
    width: 100%;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    display: block;
  }
  html[data-theme="light"] .banner-wrap {
    background: linear-gradient(180deg,#f7fafc 0%, #eef2f7 100%);
  }
  html[data-theme="dark"] .banner-wrap {
    background: linear-gradient(180deg,#071127 0%, #04101a 100%);
  }

  /* make Info/details button text follow theme text color so it's white in dark and black in light */
  .action-button[data-action="details"],
  .nearby-item .action-button[data-action="details"],
  .btn-details {
    color: var(--text);
    background: var(--glass);
    border: 1px solid rgba(255,255,255,0.06);
    font-weight: 800;
  }

  :root[data-theme="light"] .action-button[data-action="details"],
  :root[data-theme="light"] .nearby-item .action-button[data-action="details"],
  :root[data-theme="light"] .btn-details {
    background: rgba(0,0,0,0.04);
    border: 1px solid rgba(0,0,0,0.06);
    color: var(--text);
  }

  .action-button[data-action="details"]:hover,
  .nearby-item .action-button[data-action="details"]:hover,
  .btn-details:hover {
    background: linear-gradient(90deg,var(--accent),var(--accent-2));
    color: #071127;
    transform: translateY(-1px);
  }

  .leaflet-popup-content { font-family: inherit; color:var(--text); background:transparent; box-shadow:none; }
  .leaflet-popup-content-wrapper { background:var(--card-bg); border-radius:12px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.02); padding:10px; }
  .leaflet-container { background: linear-gradient(180deg, rgba(0,0,0,0.02), transparent); }

  /* Force visible Info/Details buttons everywhere (strong override to beat inline/third-party rules) */
  .action-button[data-action="details"],
  .nearby-item .action-button[data-action="details"],
  .btn-details {
    background: linear-gradient(90deg, var(--accent), var(--accent-2)) !important;
    color: #071127 !important;
    border: none !important;
    font-weight: 800;
    opacity: 1 !important;
    box-shadow: 0 4px 20px rgba(255,122,89,0.25) !important;
  }

  .action-button[data-action="details"]:hover,
  .nearby-item .action-button[data-action="details"]:hover,
  .btn-details:hover {
    transform: translateY(-1px);
    box-shadow: 0 0 15px rgba(255,122,89,0.4) !important;
  }

  </style>

  <!-- jsPDF CDN (added as requested) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header class="topnav" role="navigation" aria-label="Main navigation">
    <div class="brand" aria-hidden="true">
      <div class="logo" aria-hidden="true">HH</div>
      <div>HungerHero</div>
    </div>

    <nav class="navlinks" aria-label="Primary navigation">
      <a href="#/" class="navlink" data-route="/">Home</a>
      <a href="#/finder" class="navlink" data-route="/finder">Finder</a>
      <a href="#/ngo" class="navlink" data-route="/ngo">NGO</a>
      <a href="#/volunteers" class="navlink" data-route="/volunteers">Volunteers</a>
      <a href="#/contact" class="navlink" data-route="/contact">Contact</a>
      <a href="#/admin" class="navlink" data-route="/admin" style="display:none" id="adminLink">Admin</a>
    </nav>

    <div class="nav-right" role="toolbar" aria-label="Top actions">
      <div class="chip" id="statDonations">Donations: 0</div>
      <button id="themeToggle" class="btn-ghost" title="Toggle theme (Alt+T)" aria-pressed="false">Theme</button>
      <button id="openDonate" class="btn" aria-haspopup="dialog">Donate</button>
    </div>
  </header>

  <main id="app" class="container" role="main" tabindex="-1"></main>

  <!-- NOTE: The previous bottom floating donate button was removed per request. -->

  <!-- Modal: donate reused across site -->
  <div id="donateModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="donateTitle">
      <h3 id="donateTitle">Quick Donate — Request a pickup</h3>
      <p class="small" id="donateHint">Short form for quick pickups. Use full Google Form for receipts.</p>

      <form id="donateForm" autocomplete="on">
        <div class="form-row" style="margin-top:10px">
          <div class="field">
            <label class="small" for="donorName">Your name</label>
            <input id="donorName" name="name" type="text" placeholder="Full name" required />
          </div>
          <div class="field">
            <label class="small" for="donorPhone">Phone</label>
            <input id="donorPhone" name="phone" type="tel" placeholder="+971 5x xxx xxxx" required />
          </div>
        </div>

        <div style="margin-top:10px">
          <label class="small" for="donorItems">What are you donating?</label>
          <textarea id="donorItems" name="items" placeholder="e.g., 10 packaged meals, 5 cans" required></textarea>
        </div>

        <div class="form-row" style="margin-top:10px">
          <div class="field">
            <label class="small" for="pickupAddress">Pickup address</label>
            <input id="pickupAddress" name="address" type="text" placeholder="Villa, building or street" required />
          </div>
          <div class="field">
            <label class="small" for="preferredCenter">Preferred center</label>
            <select id="preferredCenter" name="center" aria-label="Preferred center"><option value="">No preference</option></select>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <label style="display:inline-flex;align-items:center;gap:8px"><input type="checkbox" id="shareLocation" /> Share my location</label>
          <div class="small" style="margin-left:auto">Full form opens for receipts</div>
        </div>

        <div class="modal-actions">
          <button type="button" id="openGoogleFormBtn" class="btn-ghost">Open Google Form</button>
          <button type="reset" id="resetForm" class="btn-ghost">Reset</button>
          <button type="submit" class="btn">Request pickup</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-wrap" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- templates -->
  <script type="text/template" id="tpl-home">
    <!-- Banner is now part of the home template so it only appears on the home route -->
    <div class="banner-wrap">
      <img src="Donate to Fight Hunger Together.png" alt="Donate to Fight Hunger Together — HungerHero UAE Banner" />
    </div>

    <section class="card hero" aria-labelledby="home-title">
      <div>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
          <div class="badge" style="background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#071127;padding:6px 10px;border-radius:999px">HungerHero</div>
          <div class="small">UAE • Match Donations • Connect Volunteers</div>
        </div>

        <h1 id="home-title">Make a donation. Change a life — fast.</h1>
        <p class="lead">Find verified food centers across the UAE, request a pickup, or submit a donation quickly. Mobile-first, low-friction flows.</p>

        <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
          <!-- ONE-TAP DONATE: changed to open external form link directly -->
          <button class="cta-big btn" id="homeDonateBtn" aria-label="Donate now">One-tap Donate</button>
          <a class="action-button" href="#/finder">Find nearest centers →</a>
          <a class="action-button" href="#/ngo">Register NGO →</a>
        </div>

        <div class="stats-grid" style="margin-top:18px">
          <div class="stat"><div class="small">Donations processed</div><strong id="donationsCount">0</strong></div>
          <div class="stat"><div class="small">Volunteers signed</div><strong id="volunteersCount">0</strong></div>
          <div class="stat"><div class="small">Verified NGOs</div><strong id="ngosCount">0</strong></div>
        </div>

      </div>

      <aside>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:900">Featured centers</div>
            <div class="small">Trusted & active</div>
          </div>
          <div id="featuredList" style="margin-top:12px"></div>
        </div>
      </aside>
    </section>
  </script>

  <script type="text/template" id="tpl-finder">
    <section aria-labelledby="finder-title">
      <h2 id="finder-title">Finder — Map & Nearby</h2>
      <p class="small">Filter by emirate, food type, or verification. Click a marker for details and request pickup.</p>

      <div style="display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:12px">
        <div>
          <div class="controls" role="region" aria-label="Map controls">
            <input id="finderSearch" class="filters" placeholder="Search centers, area or emirate" aria-label="Search centers" />
            <select id="emirate" class="filters" aria-label="Filter by emirate">
              <option value="all">All Emirate</option>
              <option>Abu Dhabi</option><option>Dubai</option><option>Sharjah</option>
              <option>Ajman</option><option>Umm Al Quwain</option><option>Ras Al Khaimah</option><option>Fujairah</option>
            </select>
            <select id="foodtype" class="filters" aria-label="Filter by food type">
              <option value="all">All types</option><option>Cooked</option><option>Packaged</option><option>Canned</option>
            </select>
            <select id="verified" class="filters" aria-label="Filter by verification">
              <option value="all">Any verification</option><option value="true">Verified only</option><option value="false">Unverified only</option>
            </select>
            <button id="findMe" class="btn-ghost">Find Near Me</button>
            <button id="centerUAE" class="btn-ghost">Center UAE</button>
          </div>

          <div class="map-wrap" style="margin-top:10px;transition:box-shadow .18s">
            <div id="map" style="height:520px" role="application" aria-label="Map of food centers"></div>
          </div>
        </div>

        <aside class="side-column" aria-live="polite">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Nearby centers</div>
              <div class="small">Tap to route</div>
            </div>
            <div id="nearbyList" style="margin-top:12px"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <div style="font-weight:900">Quick tools</div>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
              <button id="showAll" class="action-button">Show all</button>
              <button id="routeFirst" class="action-button">Route to nearest</button>
              <button id="exportCsv" class="action-button">Export centers (CSV)</button>
            </div>
          </div>
        </aside>
      </div>
    </section>
  </script>

  <script type="text/template" id="tpl-ngo">
    <section>
      <h2>NGO Registration & Verification</h2>
      <p class="small">Register your NGO to become a verified partner. Verification usually takes 2–5 business days.</p>

      <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px">
        <div>
          <div class="card">
            <h3 style="margin-top:0">How verification works</h3>
            <ol class="small">
              <li>Submit registration details via the NGO form (legal name, license, contact person).</li>
              <li>Upload proof of registration (license/registration certificate) and a recent utility bill or office lease.</li>
              <li>Our team reviews documents and may request a short site visit or video call.</li>
              <li>Once verified, your NGO is prioritized for pickups and featured on Finder.</li>
            </ol>
            <h4 style="margin-top:10px">Benefits of verification</h4>
            <ul class="small">
              <li>Higher pickup priority & faster response times</li>
              <li>Featured placement in the Finder</li>
              <li>Access to volunteer dispatch and logistics support</li>
            </ul>

            <div style="margin-top:12px;display:flex;gap:10px">
              <button id="downloadChecklist" class="action-button">Download checklist</button>
              <button class="action-button primary" id="ngoFormBtn">Open NGO form</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h4 style="margin:0 0 6px">Required documents (typical)</h4>
            <ul class="small">
              <li>Organization registration/license (PDF)</li>
              <li>Signed letter or authorization from NGO head</li>
              <li>Proof of bank account (for donations)</li>
              <li>Contact person details and phone</li>
            </ul>
            <div style="margin-top:8px" class="small">Questions? Email <a href="mailto:partners@hungerhero.example">partners@hungerhero.example</a> or call <a href="tel:+971500000000">+971 50 000 0000</a>.</div>
          </div>
        </div>

        <aside>
          <div class="card">
            <h4 style="margin:0 0 6px">Next steps</h4>
            <div class="small">After you submit the NGO form our team will:</div>
            <ol class="small" style="margin-top:8px">
              <li>Confirm receipt and send verification checklist.</li>
              <li>Review documents within 2–5 business days.</li>
              <li>Notify you and update your profile status.</li>
            </ol>
            <div style="margin-top:8px">
              <button id="contactNgoSupport" class="action-button">Contact verification team</button>
            </div>
          </div>
        </aside>
      </div>
    </section>
  </script>

  <script type="text/template" id="tpl-volunteers">
    <section>
      <h2>Volunteers</h2>
      <p class="small">Drivers, packers and coordinators — sign up to help. Drivers must have a valid UAE license.</p>

      <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px">
        <div>
          <div class="card">
            <h3 style="margin-top:0">Roles we need</h3>
            <ul class="small">
              <li><strong>Drivers</strong> — pickup & dropoff (UAE license required)</li>
              <li><strong>Packers</strong> — sort and pack donated food items</li>
              <li><strong>Coordinators</strong> — manage volunteers, schedules and pickups</li>
            </ul>

            <h4 style="margin-top:10px">Training & onboarding</h4>
            <p class="small">We provide a short (2–3 hour) onboarding that covers safety, food handling, and pickup checklist. Training sessions run weekly.</p>

            <h4 style="margin-top:10px">Sign up (quick)</h4>
            <form id="volunteerForm" class="small-form" style="margin-top:8px">
              <div class="form-row">
                <div class="field">
                  <label class="small" for="volName">Full name</label>
                  <input id="volName" required />
                </div>
                <div class="field">
                  <label class="small" for="volPhone">Phone</label>
                  <input id="volPhone" required />
                </div>
              </div>

              <div style="margin-top:8px" class="form-row">
                <div class="field">
                  <label class="small" for="volRole">Preferred role</label>
                  <select id="volRole">
                    <option>Driver</option><option>Packer</option><option>Coordinator</option>
                  </select>
                </div>
                <div class="field">
                  <label class="small" for="volAvail">Availability</label>
                  <input id="volAvail" placeholder="e.g., Weekends, Weekdays mornings" />
                </div>
              </div>

              <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                <label class="small"><input type="checkbox" id="volHasLicense" /> I have a valid UAE driving license (if Driver)</label>
                <div style="margin-left:auto" class="small">We will contact you within 48h</div>
              </div>

              <div style="margin-top:10px" class="modal-actions">
                <button type="reset" class="btn-ghost">Reset</button>
                <button type="submit" class="btn">Sign up</button>
              </div>
            </form>

            <div style="margin-top:12px" class="small">Prefer to use the official signup form? <button id="volGoogle" class="action-button">Open volunteer form</button></div>
          </div>
        </div>

        <aside>
          <div class="card">
            <h4 style="margin:0 0 6px">Shifts & scheduling</h4>
            <div class="small">Shifts are typically 3–4 hours. Drivers are scheduled based on availability and proximity.</div>
            <div style="margin-top:10px">
              <button id="volGuidelines" class="action-button">Volunteer guidelines</button>
            </div>
          </div>
        </aside>
      </div>
    </section>
  </script>

  <!-- Replaced tpl-contact with the version that includes the Contact Form link (kept information unchanged) -->
  <script type="text/template" id="tpl-contact">
    <section>
      <h2>Contact</h2>
      <p class="small">Questions or feedback? Use the contact form below, email support@hungerhero.example or call our support line.</p>

      <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px">
        <div>
          <div class="card">
            <h3 style="margin-top:0">Send a message</h3>
            <form id="contactFormLocal" class="small-form" style="margin-top:8px">
              <div class="form-row">
                <div class="field"><label class="small" for="contactName">Name</label><input id="contactName" required /></div>
                <div class="field"><label class="small" for="contactEmail">Email</label><input id="contactEmail" type="email" required /></div>
              </div>
              <div style="margin-top:8px" class="field">
                <label class="small" for="contactSubject">Subject</label>
                <input id="contactSubject" placeholder="e.g., Support request" />
              </div>
              <div style="margin-top:8px" class="field">
                <label class="small" for="contactMessage">Message</label>
                <textarea id="contactMessage" placeholder="Write your message here..." required></textarea>
              </div>
              <div style="margin-top:10px" class="modal-actions">
                <button type="reset" class="btn-ghost">Reset</button>
                <button type="submit" class="btn">Send message</button>
              </div>
            </form>
          </div>

          <!-- Added new Contact Form button -->
          <div class="card" style="margin-top:12px">
            <h4 style="margin:0 0 6px">Support channels</h4>
            <div class="small">Phone: <a href="tel:+971500000000">+971 50 000 0000</a></div>
            <div class="small">Email: <a href="mailto:support@hungerhero.example">support@hungerhero.example</a></div>
            <div class="small" style="margin-top:8px">Office hours: Mon–Fri 09:00–17:00</div>
            <div style="margin-top:10px">
              <a class="action-button" href="https://twitter.com/" target="_blank" rel="noopener">Twitter</a>
              <a class="action-button" href="https://facebook.com/" target="_blank" rel="noopener">Facebook</a>
              <!-- New contact form link -->
              <a class="action-button" href="https://forms.gle/vo13BKkA9oa9uKfp8" target="_blank" rel="noopener">Contact Form</a>
            </div>
          </div>
        </div>

        <aside>
          <div class="card">
            <h4 style="margin:0 0 6px">Common questions</h4>
            <details class="small" style="margin-top:8px"><summary>How long for a pickup?</summary><div style="margin-top:8px">Pickup times vary. Verified NGOs are faster; typical window is 24–72 hours depending on availability.</div></details>
            <details class="small" style="margin-top:8px"><summary>Can I donate cash?</summary><div style="margin-top:8px">This platform focuses on food and in-kind donations; for cash donations we redirect to NGO channels. Contact support for guidance.</div></details>
          </div>
        </aside>
      </div>
    </section>
  </script>

  <script type="text/template" id="tpl-admin">
    <section>
      <h2>Admin (demo)</h2>
      <p class="small">Admin tools to manage centers (demo only). Toggle the verification status or add new centers. Secret route requires a passphrase.</p>

      <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px">
        <div>
          <div class="card">
            <h3 style="margin-top:0">Centers</h3>
            <div id="adminCenters" style="margin-top:8px"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h4 style="margin:0 0 6px">Add center</h4>
            <form id="addCenterForm" class="small-form">
              <div class="form-row">
                <div class="field"><label class="small">Name</label><input id="newCenterName" required /></div>
                <div class="field"><label class="small">Emirate</label><input id="newCenterEmirate" required /></div>
              </div>
              <div style="margin-top:8px" class="form-row">
                <div class="field"><label class="small">Area</label><input id="newCenterArea" required /></div>
                <div class="field"><label class="small">Type</label><select id="newCenterType"><option>Cooked</option><option>Packaged</option><option>Canned</option></select></div>
              </div>
              <div style="margin-top:8px" class="form-row">
                <div class="field"><label class="small">Latitude</label><input id="newCenterLat" type="text" required /></div>
                <div class="field"><label class="small">Longitude</label><input id="newCenterLng" type="text" required /></div>
              </div>
              <div style="margin-top:10px" class="modal-actions">
                <button type="reset" class="btn-ghost">Reset</button>
                <button type="submit" class="btn">Add center</button>
              </div>
            </form>
          </div>
        </div>

        <aside>
          <div class="card">
            <h4 style="margin:0 0 6px">Admin actions</h4>
            <div style="display:flex;gap:8px;flex-direction:column">
              <button id="exportAllData" class="action-button">Export all data (JSON)</button>
              <button id="resetDemo" class="action-button">Reset demo data</button>
            </div>
            <div style="margin-top:12px" class="small">This admin is a demo. For production use an authenticated admin panel and secure backend.</div>
          </div>
        </aside>
      </div>
    </section>
  </script>

  <!-- core SPA + lazy map + service worker blob -->
  <script>
/* HungerHero SPA - final single-file
   - Theme toggle fix implemented: toggles data-theme on <html>
   - All previously included features kept and polished
   - Changes made:
     * The "One-tap Donate" button on the home page now opens the provided Google Form link directly.
     * The bottom floating donate button (fab) has been removed from the DOM (and its click hookup removed).
     * showDetails(c) was replaced: instead of building and showing an HTML panel it now generates a PDF via jsPDF and downloads it.
*/

(() => {
  const LINKS = {
    DONATE: 'https://forms.gle/84aq5mjkiikK8Szh6', // existing donate form (kept for other flows)
    NGO: 'https://forms.gle/49jtfjFodvr4epjP9',
    VOLUNTEER: 'https://forms.gle/b6iVVxQPLxv8JU7HA',
    CONTACT: 'https://forms.gle/UJEP46PQQUFTvkRv9',
    ONE_TAP_DONATE: 'https://forms.gle/bZvH3yJsLUqAg8ZF7' // <-- new one-tap donation URL requested
  };

  // Default centers persisted in localStorage key 'hh_centers_v2'
  const DEFAULT_CENTERS = [
    {id:1,name:'Food Bank Abu Dhabi', emirate:'Abu Dhabi', area:'Corniche Rd', type:'Canned', lat:24.4769, lng:54.3656, phone:'+97126800001', hours:'Mon–Sat 09:00–17:00', verified:true, capacity:'High', website:'#'},
    {id:2,name:'Abu Dhabi Charity Center', emirate:'Abu Dhabi', area:'Al Khalidiya', type:'Cooked', lat:24.4666, lng:54.3610, phone:'+97126800002', hours:'Mon–Fri 08:00–16:00', verified:true, capacity:'Medium', website:'#'},
    {id:3,name:'Hope Center Abu Dhabi', emirate:'Abu Dhabi', area:'Mussafah', type:'Packaged', lat:24.3210, lng:54.4370, phone:'+97126800003', hours:'Daily 08:00–18:00', verified:false, capacity:'Low', website:'#'},
    {id:4,name:'Helping Hands Dubai', emirate:'Dubai', area:'Al Barsha 1', type:'Cooked', lat:25.1190, lng:55.1900, phone:'+97142500004', hours:'Mon–Sat 09:00–18:00', verified:true, capacity:'High', website:'#'},
    {id:5,name:'Share the Love Dubai', emirate:'Dubai', area:'Downtown Dubai', type:'Packaged', lat:25.1972, lng:55.2744, phone:'+97142500005', hours:'Tue–Sun 10:00–18:00', verified:true, capacity:'Medium', website:'#'},
    {id:6,name:'Dubai Food Relief', emirate:'Dubai', area:'Deira', type:'Canned', lat:25.2637, lng:55.3092, phone:'+97142500006', hours:'Daily 08:00–20:00', verified:false, capacity:'Medium', website:'#'},
    {id:7,name:'Care4U Sharjah', emirate:'Sharjah', area:'Al Majaz', type:'Packaged', lat:25.3546, lng:55.3811, phone:'+97165300007', hours:'Mon–Fri 09:00–17:00', verified:true, capacity:'Low', website:'#'},
    {id:8,name:'Sharjah Food Bank', emirate:'Sharjah', area:'Industrial Area', type:'Cooked', lat:25.3170, lng:55.3977, phone:'+97165300008', hours:'Daily 07:00–19:00', verified:true, capacity:'High', website:'#'},
    {id:9,name:'Ajman Charity Center', emirate:'Ajman', area:'Ajman Corniche', type:'Canned', lat:25.4040, lng:55.4810, phone:'+97167200009', hours:'Mon–Sat 09:00–16:00', verified:false, capacity:'Low', website:'#'},
    {id:10,name:'Ajman Helping Hands', emirate:'Ajman', area:'Al Jurf', type:'Packaged', lat:25.3990, lng:55.4690, phone:'+97167200010', hours:'Tue–Sun 09:00–17:00', verified:true, capacity:'Medium', website:'#'},
    {id:11,name:'UAQ Food Relief', emirate:'Umm Al Quwain', area:'UAQ Main St', type:'Cooked', lat:25.5645, lng:55.5479, phone:'+97167200011', hours:'Mon–Fri 09:00–15:00', verified:false, capacity:'Low', website:'#'},
    {id:12,name:'UAQ Charity Center', emirate:'Umm Al Quwain', area:'Al Raas', type:'Canned', lat:25.5860, lng:55.5460, phone:'+97167200012', hours:'Wed–Sun 10:00–16:00', verified:true, capacity:'Low', website:'#'},
    {id:13,name:'RAK Food Aid', emirate:'Ras Al Khaimah', area:'RAK City Center', type:'Packaged', lat:25.7890, lng:55.9430, phone:'+97172200013', hours:'Daily 08:00–18:00', verified:true, capacity:'Medium', website:'#'},
    {id:14,name:'RAK Charity Hub', emirate:'Ras Al Khaimah', area:'Al Nakheel', type:'Cooked', lat:25.7320, lng:55.9120, phone:'+97172200014', hours:'Mon–Sat 08:00–16:00', verified:false, capacity:'Medium', website:'#'},
    {id:15,name:'Fujairah Helping Hands', emirate:'Fujairah', area:'Fujairah Port', type:'Canned', lat:25.1278, lng:56.3269, phone:'+97192200015', hours:'Tue–Sun 09:00–17:00', verified:true, capacity:'Low', website:'#'},
    {id:16,name:'Fujairah Food Relief', emirate:'Fujairah', area:'Central Market', type:'Packaged', lat:25.1230, lng:56.3260, phone:'+97192200016', hours:'Mon–Fri 08:00–16:00', verified:false, capacity:'Low', website:'#'}
  ];

  // Helpers
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const tpl = id => document.getElementById(id).innerHTML;
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
  function uid(prefix='id'){ return prefix + Math.random().toString(36).slice(2,9); }

  // Centers storage
  function loadCenters(){
    try {
      const raw = localStorage.getItem('hh_centers_v2');
      if (!raw) { localStorage.setItem('hh_centers_v2', JSON.stringify(DEFAULT_CENTERS)); return DEFAULT_CENTERS.slice(); }
      return JSON.parse(raw);
    } catch(e){ console.error('centers load err', e); return DEFAULT_CENTERS.slice(); }
  }
  function saveCenters(list){ localStorage.setItem('hh_centers_v2', JSON.stringify(list)); }
  let centers = loadCenters();

  // Toasts
  const toastWrap = document.getElementById('toasts');
  function toast(message, {type='info', duration=4500, action} = {}) {
    const id = uid('t');
    const el = document.createElement('div');
    el.className = 'toast ' + (type==='success'?'success': type==='warn'?'warn':'');
    el.id = id;
    el.innerHTML = `<div>${escapeHtml(message)}</div><div>${action ? `<button class="btn-inline" data-action> ${escapeHtml(action.label || 'Action')} </button>` : ''}<button class="btn-inline" data-close>✕</button></div>`;
    toastWrap.appendChild(el);
    if (action) el.querySelector('[data-action]').addEventListener('click', ()=> { action.cb(); removeToast(); });
    el.querySelector('[data-close]').addEventListener('click', removeToast);
    const to = setTimeout(removeToast, duration);
    function removeToast(){
      clearTimeout(to);
      el.style.opacity = '0'; setTimeout(()=> el.remove(), 200);
    }
    return id;
  }

  // Modal focus trap helpers
  function trapFocus(modalRoot){
    const focusable = 'a[href],button:not([disabled]),textarea,input,select,[tabindex]:not([tabindex="-1"])';
    const nodes = modalRoot.querySelectorAll(focusable);
    if (!nodes.length) return;
    const first = nodes[0], last = nodes[nodes.length-1];
    function keyHandler(e){
      if (e.key === 'Tab'){
        if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
      } else if (e.key === 'Escape'){ closeDonateModal(); }
    }
    modalRoot._th = keyHandler;
    document.addEventListener('keydown', keyHandler);
    first && first.focus();
  }
  function releaseFocus(modalRoot){
    if (modalRoot && modalRoot._th) document.removeEventListener('keydown', modalRoot._th);
  }

  // Modal open/close
  const donateModalEl = document.getElementById('donateModal');
  function openDonateModal(prefCenter){
    const sel = $('#preferredCenter', donateModalEl);
    sel.innerHTML = '<option value="">No preference</option>' + centers.map(c=>`<option>${escapeHtml(c.name)}</option>`).join('');
    if (prefCenter) sel.value = prefCenter;
    donateModalEl.classList.add('open');
    donateModalEl.setAttribute('aria-hidden','false');
    donateModalEl.style.display = 'flex';
    trapFocus(donateModalEl);
  }
  function closeDonateModal(){
    donateModalEl.style.display = 'none';
    donateModalEl.setAttribute('aria-hidden','true');
    releaseFocus(donateModalEl);
    $('#donateForm').reset();
  }
  donateModalEl.addEventListener('click', (ev)=> { if (ev.target === donateModalEl) closeDonateModal(); });

  // Donate submit
  $('#donateForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const name = $('#donorName').value.trim();
    const phone = $('#donorPhone').value.trim();
    const items = $('#donorItems').value.trim();
    const address = $('#pickupAddress').value.trim();
    const centerName = $('#preferredCenter').value;
    if (!name || !phone || !items || !address){ toast('Please complete required fields', {type:'warn'}); return; }

    let record = { id: uid('don'), name, phone, items, address, center: centerName, ts: new Date().toISOString() };

    if ($('#shareLocation').checked && navigator.geolocation){
      try{
        const pos = await new Promise((res, rej)=> navigator.geolocation.getCurrentPosition(res, rej, {enableHighAccuracy:true, timeout:10000}));
        record.lat = pos.coords.latitude; record.lng = pos.coords.longitude;
      }catch(e){}
    }

    const saved = JSON.parse(localStorage.getItem('hh_donations') || '[]');
    saved.unshift(record);
    localStorage.setItem('hh_donations', JSON.stringify(saved));
    updateStats();
    toast('Pickup request saved (demo)', {type:'success', action:{label:'Open Form', cb:()=> window.open(LINKS.DONATE, '_blank')}});

    toast('Undo? Your request was saved locally', {type:'warn', duration:7000, action:{label:'Undo', cb: ()=>{
      const s = JSON.parse(localStorage.getItem('hh_donations')||'[]').filter(r=> r.id !== record.id);
      localStorage.setItem('hh_donations', JSON.stringify(s));
      updateStats();
      toast('Donation undone', {type:'success', duration:2000});
    }}});

    window.open(LINKS.DONATE, '_blank', 'noopener');
    closeDonateModal();
  });

  $('#openGoogleFormBtn').addEventListener('click', ()=> window.open(LINKS.DONATE, '_blank', 'noopener'));

  // Theme toggle implementation (fix)
  const themeToggle = document.getElementById('themeToggle');
  function setTheme(t){
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('hh_theme', t);
    themeToggle.setAttribute('aria-pressed', t === 'light' ? 'true' : 'false');
    themeToggle.textContent = t === 'light' ? 'Light' : 'Dark';
    // update meta theme-color for mobile browser color
    const meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', t === 'light' ? '#f7fafc' : '#071127');
  }
  themeToggle.addEventListener('click', ()=>{
    const cur = localStorage.getItem('hh_theme') || 'dark';
    const next = cur === 'dark' ? 'light' : 'dark';
    setTheme(next);
    toast(`Theme switched to ${next}`, {type:'success', duration:1500});
  });
  window.addEventListener('keydown', (e)=> { if (e.altKey && e.key.toLowerCase() === 't'){ e.preventDefault(); themeToggle.click(); } });
  // initialize theme from localStorage or system
  (function initTheme(){
    const saved = localStorage.getItem('hh_theme');
    if (saved) { setTheme(saved); }
    else {
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      setTheme(prefersLight ? 'light' : 'dark');
    }
  })();

  // Welcome toast (once per session)
  function readyToast(){
    if (!sessionStorage.getItem('hh_welcome_shown')){
      toast('Welcome to HungerHero — press "d" to donate, "/" to search, Alt+T to toggle theme', {duration:6000});
      sessionStorage.setItem('hh_welcome_shown', '1');
    }
  }

  // Stats loading
  function loadStats(){
    const donations = JSON.parse(localStorage.getItem('hh_donations')||'[]');
    const volunteers = JSON.parse(localStorage.getItem('hh_volunteers')||'[]');
    const ngos = centers.filter(c=>c.verified).length;
    $('#donationsCount') && ($('#donationsCount').textContent = donations.length);
    $('#volunteersCount') && ($('#volunteersCount').textContent = volunteers.length);
    $('#ngosCount') && ($('#ngosCount').textContent = ngos);
    $('#statDonations') && ($('#statDonations').textContent = 'Donations: ' + donations.length);
  }
  function updateStats(){ loadStats(); }

  // Featured
  function renderFeatured(){
    const el = $('#featuredList');
    if (!el) return;
    const featured = centers.filter(c=>c.verified).slice(0,4);
    el.innerHTML = featured.map(c=>`
      <div class="featured-item">
        <div class="avatar">${escapeHtml(c.name[0])}</div>
        <div style="flex:1"><strong>${escapeHtml(c.name)}</strong><div class="small">${escapeHtml(c.area)}</div></div>
        <div><button class="action-button" data-id="${c.id}" data-role="view">Open</button></div>
      </div>
    `).join('');
    el.querySelectorAll('[data-role="view"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = Number(btn.dataset.id);
        const c = centers.find(x=>x.id===id);
        location.hash = '#/finder';
        const tryShow = () => {
          if (mapLoaded && mapInstance){
            showDetails(c);
            mapInstance.setView([c.lat,c.lng], 13);
            openPopupForCenter(c.id);
          } else setTimeout(tryShow, 200);
        };
        tryShow();
      });
    });
  }

  // Routing and render
  function getRoute(){ const h = location.hash || '#/'; return h.replace(/^#/, '') || '/'; }
  function setActiveNav(route){ $$('.navlink').forEach(a => { const r = a.getAttribute('href').replace(/^#/, ''); a.classList.toggle('active', r === route); }); }

  function render(){
    const route = getRoute();
    setActiveNav(route);
    const app = $('#app');
    app.innerHTML = '';
    switch(route){
      case '/':
        app.innerHTML = tpl('tpl-home');
        setTimeout(()=> {
          // ONE-TAP DONATE: open the requested external form link directly
          $('#homeDonateBtn')?.addEventListener('click', ()=> {
            window.open(LINKS.ONE_TAP_DONATE, '_blank', 'noopener');
          });
          renderFeatured();
          loadStats();
          readyToast();
        }, 60);
        break;
      case '/finder': app.innerHTML = tpl('tpl-finder'); setTimeout(()=> initFinderView(), 80); break;
      case '/ngo': app.innerHTML = tpl('tpl-ngo'); setTimeout(()=> { $('#downloadChecklist')?.addEventListener('click', downloadChecklist); $('#ngoFormBtn')?.addEventListener('click', ()=> window.open(LINKS.NGO,'_blank')); $('#contactNgoSupport')?.addEventListener('click', ()=> window.location.href = 'mailto:partners@hungerhero.example'); loadStats(); }, 30); break;
      case '/volunteers': app.innerHTML = tpl('tpl-volunteers'); setTimeout(()=> { $('#volunteerForm')?.addEventListener('submit', handleVolunteerSubmit); $('#volGoogle')?.addEventListener('click', ()=> window.open(LINKS.VOLUNTEER,'_blank')); loadStats(); }, 30); break;
      case '/contact': app.innerHTML = tpl('tpl-contact'); setTimeout(()=> { $('#contactFormLocal')?.addEventListener('submit', handleContactSubmit); loadStats(); }, 30); break;
      case '/admin': {
        if (!sessionStorage.getItem('hh_admin_ok')){
          const pass = prompt('Enter admin passphrase (demo):');
          if (pass !== 'hero-admin-2025'){ location.hash = '#/'; toast('Invalid passphrase', {type:'warn'}); return; }
          sessionStorage.setItem('hh_admin_ok','1');
        }
        app.innerHTML = tpl('tpl-admin');
        setTimeout(()=> initAdminView(), 60);
      } break;
      default: app.innerHTML = '<div class="card"><h2>Not found</h2><p class="small">Page not found.</p></div>';
    }
    setTimeout(()=> app.focus(), 80);
  }

  // Volunteer & Contact handlers
  function handleVolunteerSubmit(ev){
    ev.preventDefault();
    const data = {
      id: uid('vol'),
      name: $('#volName').value.trim(),
      phone: $('#volPhone').value.trim(),
      role: $('#volRole').value,
      availability: $('#volAvail').value.trim(),
      hasLicense: $('#volHasLicense').checked,
      ts: new Date().toISOString()
    };
    if (!data.name || !data.phone){ toast('Please provide name and phone', {type:'warn'}); return; }
    const saved = JSON.parse(localStorage.getItem('hh_volunteers')||'[]');
    saved.unshift(data);
    localStorage.setItem('hh_volunteers', JSON.stringify(saved));
    toast('Thanks for signing up! We will contact you.', {type:'success'});
    updateStats();
    $('#volunteerForm').reset();
  }

  function handleContactSubmit(ev){
    ev.preventDefault();
    const data = {
      id: uid('msg'),
      name: $('#contactName').value.trim(),
      email: $('#contactEmail').value.trim(),
      subject: $('#contactSubject').value.trim(),
      message: $('#contactMessage').value.trim(),
      ts: new Date().toISOString()
    };
    if (!data.name || !data.email || !data.message){ toast('Please complete required fields', {type:'warn'}); return; }
    const saved = JSON.parse(localStorage.getItem('hh_contacts')||'[]');
    saved.unshift(data);
    localStorage.setItem('hh_contacts', JSON.stringify(saved));
    toast('Message saved — support will reply within 48 hours (demo)', {type:'success'});
    $('#contactFormLocal').reset();
  }

  // Admin view
  function initAdminView(){
    $('#adminLink').style.display = 'inline-flex';
    const container = $('#adminCenters');
    function renderCentersList(){
      centers = loadCenters();
      container.innerHTML = centers.map(c=> `
        <div style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>${escapeHtml(c.name)}</strong><div class="small">${escapeHtml(c.area)} • ${escapeHtml(c.emirate)}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" data-id="${c.id}" ${c.verified ? 'checked' : ''} /> Verified</label>
            <button class="action-button" data-id="${c.id}" data-action="remove">Remove</button>
          </div>
        </div>
      `).join('');
      container.querySelectorAll('[data-action="remove"]').forEach(btn=> btn.addEventListener('click', ()=>{
        const id = Number(btn.dataset.id);
        if (!confirm('Remove center?')) return;
        centers = centers.filter(x=> x.id !== id);
        saveCenters(centers);
        renderCentersList();
        toast('Center removed', {type:'warn'});
      }));
      container.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.addEventListener('change', ()=>{
          const id = Number(cb.dataset.id);
          centers = centers.map(x=> x.id===id ? {...x, verified: cb.checked} : x);
          saveCenters(centers);
          toast('Verification toggled', {type:'success'});
          updateStats();
        });
      });
    }
    renderCentersList();

    $('#addCenterForm').addEventListener('submit', (ev)=>{
      ev.preventDefault();
      const name = $('#newCenterName').value.trim();
      const emirate = $('#newCenterEmirate').value.trim();
      const area = $('#newCenterArea').value.trim();
      const type = $('#newCenterType').value;
      const lat = parseFloat($('#newCenterLat').value);
      const lng = parseFloat($('#newCenterLng').value);
      if (!name || !emirate || !area || Number.isNaN(lat) || Number.isNaN(lng)){ toast('Complete all fields correctly', {type:'warn'}); return; }
      const id = centers.reduce((m,c)=> Math.max(m,c.id), 0) + 1;
      centers.push({id,name,emirate,area,type,lat,lng,phone:'',hours:'',verified:false,capacity:'Medium',website:'#'});
      saveCenters(centers);
      toast('Center added', {type:'success'});
      $('#addCenterForm').reset();
      initAdminView(); // re-render
    });

    $('#exportAllData').addEventListener('click', ()=>{
      const data = { centers, donations: JSON.parse(localStorage.getItem('hh_donations')||'[]'), volunteers: JSON.parse(localStorage.getItem('hh_volunteers')||'[]'), contacts: JSON.parse(localStorage.getItem('hh_contacts')||'[]')};
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'hungerhero-data.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      toast('Export started', {type:'success'});
    });

    $('#resetDemo').addEventListener('click', ()=>{
      if (!confirm('Reset demo data to defaults? This clears local data.')) return;
      localStorage.clear();
      centers = loadCenters();
      toast('Demo reset. Reloading...', {type:'success'});
      setTimeout(()=> location.reload(), 800);
    });
  }

  // Map implementation (lazy load)
  let mapLoaded=false, mapInstance=null, markersLayer=null, lastPolyline=null, userMarker=null, centerMarkers={};
  function loadLeaflet(cb){
    if (window.L) { cb(); return; }
    const css1 = document.createElement('link'); css1.rel='stylesheet'; css1.href='https://unpkg.com/leaflet/dist/leaflet.css'; document.head.appendChild(css1);
    const css2 = document.createElement('link'); css2.rel='stylesheet'; css2.href='https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css'; document.head.appendChild(css2);
    const css3 = document.createElement('link'); css3.rel='stylesheet'; css3.href='https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css'; document.head.appendChild(css3);
    const s1 = document.createElement('script'); s1.src='https://unpkg.com/leaflet/dist/leaflet.js'; s1.onload = ()=> {
      const s2 = document.createElement('script'); s2.src='https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js'; s2.onload = cb; document.body.appendChild(s2);
    };
    document.body.appendChild(s1);
  }

  function buildMap(){
    if (mapInstance) return;
    mapInstance = L.map('map', {zoomControl:true, preferCanvas:true});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap contributors'}).addTo(mapInstance);
    markersLayer = L.markerClusterGroup({chunkedLoading:true, maxClusterRadius:50});
    mapInstance.addLayer(markersLayer);
    mapInstance.setView([24.4539,54.3773], 9);
    mapInstance.on('popupopen', ()=> setTimeout(bindPopupButtons, 20));
  }

  function markerHtml(type, verified){
    const color = (type === 'Cooked') ? '#ff7a59' : (type==='Packaged' ? '#6fda8a' : '#69b1ff');
    return `<div style="width:40px;height:40px;border-radius:10px;background:${color};display:flex;align-items:center;justify-content:center;font-weight:900;color:#071127">${escapeHtml(type[0])}${verified ? '<span style="font-size:9px;margin-left:6px;color:var(--success)">●</span>' : ''}</div>`;
  }

  function addAllMarkers(list){
    if (!mapInstance || !markersLayer) return;
    markersLayer.clearLayers();
    centerMarkers = {};
    list.forEach(c=>{
      const icon = L.divIcon({html: markerHtml(c.type,c.verified), className:'custom-marker', iconSize:[36,36], iconAnchor:[18,36]});
      const m = L.marker([c.lat,c.lng], {icon});
      m.bindPopup(createPopupHtml(c), {minWidth:220});
      m.on('popupopen', ()=> setTimeout(bindPopupButtons, 20));
      markersLayer.addLayer(m);
      centerMarkers[c.id] = m;
    });
  }

  function createPopupHtml(c){
    return `<div>
      <strong>${escapeHtml(c.name)}</strong> ${c.verified ? '<span class="verified">Verified</span>' : ''}
      <div class="small" style="margin-top:6px">${escapeHtml(c.area)} — ${escapeHtml(c.emirate)}</div>
      <div class="small" style="margin-top:6px">Type: ${escapeHtml(c.type)} • Capacity: ${escapeHtml(c.capacity)}</div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn-popup" data-id="${c.id}">Request pickup</button>
        <button class="btn-route" data-id="${c.id}">Directions</button>
        <button class="btn-details" data-id="${c.id}">Details</button>
      </div>
    </div>`;
  }

  function bindPopupButtons(){
    $$('.btn-popup').forEach(btn => btn.onclick = ()=> {
      const id = Number(btn.dataset.id);
      const c = centers.find(x=>x.id===id);
      openDonateModal(c.name);
    });
    $$('.btn-route').forEach(btn => btn.onclick = ()=> {
      const id = Number(btn.dataset.id);
      const c = centers.find(x=>x.id===id);
      if (window._lastUserPos) drawRoute(window._lastUserPos, {lat:c.lat, lng:c.lng});
      else window.open(`https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}`, '_blank', 'noopener');
    });
    $$('.btn-details').forEach(btn => btn.onclick = ()=> {
      const id = Number(btn.dataset.id);
      const c = centers.find(x=>x.id===id);
      showDetails(c);
    });
  }

  // Modified: showDetails now generates a PDF using jsPDF instead of creating an HTML details panel
  function showDetails(c){
    try {
      if (!window.jspdf || !window.jspdf.jsPDF) {
        // older UMD exposes window.jspdf.jsPDF; try to handle both shapes
      }
      const { jsPDF } = window.jspdf || (window.jspdf && window.jspdf.default) || {};
      if (!jsPDF) {
        // Best-effort fallback: try window.jspdf.jsPDF (some builds)
        if (window.jspdf && window.jspdf.jsPDF) {
          const doc = new window.jspdf.jsPDF();
          doc.text(`Center Name: ${c.name}`, 10, 20);
          doc.text(`Emirate: ${c.emirate}`, 10, 30);
          doc.text(`Area: ${c.area}`, 10, 40);
          doc.text(`Type: ${c.type}`, 10, 50);
          doc.text(`Hours: ${c.hours || 'N/A'}`, 10, 60);
          doc.text(`Capacity: ${c.capacity || 'Unknown'}`, 10, 70);
          doc.text(`Phone: ${c.phone || 'N/A'}`, 10, 80);
          doc.save(`${(c.name||'center').replace(/\s+/g, '_')}.pdf`);
          return;
        }
        toast('PDF generation library not available', {type:'warn'});
        return;
      }
      const doc = new jsPDF();
      doc.setFontSize(12);
      doc.text(`Center Name: ${c.name}`, 10, 20);
      doc.text(`Emirate: ${c.emirate}`, 10, 30);
      doc.text(`Area: ${c.area}`, 10, 40);
      doc.text(`Type: ${c.type}`, 10, 50);
      doc.text(`Hours: ${c.hours || 'N/A'}`, 10, 60);
      doc.text(`Capacity: ${c.capacity || 'Unknown'}`, 10, 70);
      doc.text(`Phone: ${c.phone || 'N/A'}`, 10, 80);
      // Optionally add more fields or formatting here
      doc.save(`${(c.name||'center').replace(/\s+/g, '_')}.pdf`);
    } catch (err) {
      console.error('Error generating PDF', err);
      toast('Failed to generate PDF', {type:'warn'});
    }
  }

  function openPopupForCenter(id){ const m = centerMarkers[id]; if (m) m.openPopup(); }

  function drawRoute(a,b){
    if (!mapInstance) return;
    if (lastPolyline) mapInstance.removeLayer(lastPolyline);
    lastPolyline = L.polyline([[a.lat,a.lng],[b.lat,b.lng]], {dashArray:'6 8', color:'#ff7a59', weight:3}).addTo(mapInstance);
    const start = L.circleMarker([a.lat,a.lng], {radius:6, color:'#00b4ff'}).addTo(mapInstance);
    const end = L.circleMarker([b.lat,b.lng], {radius:6, color:'#ff7a59'}).addTo(mapInstance);
    setTimeout(()=>{ try{ mapInstance.removeLayer(start); mapInstance.removeLayer(end); }catch(e){} },7000);
  }

  function setUserMarker(lat,lng){
    if (!mapInstance) return;
    if (userMarker) mapInstance.removeLayer(userMarker);
    userMarker = L.circleMarker([lat,lng], {radius:8, color:'#00b4ff', fill:true}).addTo(mapInstance).bindPopup('You are here').openPopup();
    window._lastUserPos = {lat,lng};
    renderNearbyList();
  }

  function haversine(aLat,aLon,bLat,bLon){
    const toRad = v => v * Math.PI / 180;
    const R = 6371;
    const dLat = toRad(bLat-aLat), dLon = toRad(bLon-aLon);
    const aa = Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat)) * Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
  }

  function findNearest(lat,lng){
    let minD = Infinity, nearest = null;
    centers.forEach(c => { const d = haversine(lat,lng,c.lat,c.lng); if (d < minD){ minD = d; nearest = {...c, d}; } });
    return nearest;
  }

  function applyFilters(){
    if (!document.getElementById('finderSearch')) return;
    const q = (document.getElementById('finderSearch').value || '').trim().toLowerCase();
    const e = document.getElementById('emirate').value;
    const t = document.getElementById('foodtype').value;
    const v = document.getElementById('verified').value;
    const filtered = centers.filter(c=>{
      if (e !== 'all' && c.emirate !== e) return false;
      if (t !== 'all' && c.type !== t) return false;
      if (v !== 'all' && String(c.verified) !== v) return false;
      if (q){
        const hay = `${c.name} ${c.area} ${c.emirate} ${c.type}`.toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });
    addAllMarkers(filtered);
    renderNearbyList(filtered);
    if (filtered.length && mapInstance) mapInstance.fitBounds(filtered.map(f=>[f.lat,f.lng]), {padding:[40,40]});
  }

  function renderNearbyList(listOverride){
    const el = document.getElementById('nearbyList');
    if (!el) return;
    const list = listOverride || centers;
    const user = window._lastUserPos;
    const decorated = list.map(c=> ({...c, d: user ? haversine(user.lat,user.lng,c.lat,c.lng) : null}))
                          .sort((a,b)=> (a.d||9999)-(b.d||9999));
    if (!decorated.length){ el.innerHTML = '<div class="small">No centers found</div>'; return; }
    el.innerHTML = decorated.slice(0,12).map(c=> `
      <div class="nearby-item" role="article" style="padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);margin-bottom:10px;display:flex;flex-direction:column">
        <div style="display:flex;justify-content:space-between"><strong>${escapeHtml(c.name)}</strong><div class="small">${c.verified ? 'Verified' : ''}</div></div>
        <div class="meta small">${escapeHtml(c.area)} • ${escapeHtml(c.type)} • ${escapeHtml(c.hours)}</div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <button class="action-button" data-id="${c.id}" data-action="route">Route</button>
          <button class="action-button" data-id="${c.id}" data-action="pickup">Request pickup</button>
          <button class="action-button" data-id="${c.id}" data-action="details">Info</button>
          <div style="margin-left:auto" class="small">${c.d ? c.d.toFixed(1) + ' km' : ''}</div>
        </div>
      </div>
    `).join('');
    el.querySelectorAll('.action-button').forEach(btn=>{
      btn.onclick = ()=> {
        const id = Number(btn.dataset.id);
        const action = btn.dataset.action;
        const c = centers.find(x=>x.id===id);
        if (action === 'route'){
          if (window._lastUserPos) drawRoute(window._lastUserPos, {lat:c.lat, lng:c.lng});
          else window.open(`https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}`, '_blank', 'noopener');
        } else if (action === 'pickup'){
          openDonateModal(c.name);
        } else if (action === 'details'){
          showDetails(c);
          mapInstance && mapInstance.setView([c.lat,c.lng],13);
        }
      };
    });
  }

  function exportCsv(){
    const csv = ['id,name,emirate,area,type,lat,lng,phone,verified'].concat(centers.map(c=>`${c.id},"${c.name}",${c.emirate},"${c.area}",${c.type},${c.lat},${c.lng},${c.phone},${c.verified}`)).join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'centers.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function initFinderView(){
    centers = loadCenters();
    if (!mapLoaded){
      loadLeaflet(()=> {
        buildMap();
        mapLoaded = true;
        addAllMarkers(centers);
        applyFilters();
      });
    } else {
      addAllMarkers(centers);
      applyFilters();
    }

    $('#finderSearch')?.addEventListener('input', applyFilters);
    $('#emirate')?.addEventListener('change', applyFilters);
    $('#foodtype')?.addEventListener('change', applyFilters);
    $('#verified')?.addEventListener('change', applyFilters);

    $('#findMe')?.addEventListener('click', ()=> {
      if (!navigator.geolocation) return toast('Geolocation not supported', {type:'warn'});
      navigator.geolocation.getCurrentPosition(pos=>{
        setUserMarker(pos.coords.latitude, pos.coords.longitude);
        const nearest = findNearest(pos.coords.latitude, pos.coords.longitude);
        if (nearest){
          mapInstance.setView([nearest.lat,nearest.lng],13);
          openPopupForCenter(nearest.id);
          drawRoute({lat:pos.coords.latitude,lng:pos.coords.longitude},{lat:nearest.lat,lng:nearest.lng});
          toast(`Nearest: ${nearest.name} — ${nearest.area} (${nearest.type}), ${nearest.d.toFixed(1)} km`, {type:'success'});
        }
      }, err=> toast('Unable to get location: ' + err.message, {type:'warn'}), {enableHighAccuracy:true, timeout:12000});
    });

    $('#centerUAE')?.addEventListener('click', ()=> mapInstance && mapInstance.setView([24.4539,54.3773], 9));
    $('#showAll')?.addEventListener('click', ()=> { addAllMarkers(centers); mapInstance && mapInstance.fitBounds(centers.map(c=>[c.lat,c.lng])); });
    $('#exportCsv')?.addEventListener('click', exportCsv);
    $('#routeFirst')?.addEventListener('click', ()=> {
      if (window._lastUserPos){ const n = findNearest(window._lastUserPos.lat, window._lastUserPos.lng); if (n) drawRoute(window._lastUserPos,{lat:n.lat,lng:n.lng}); }
      else toast('Use Find Near Me first', {type:'warn'});
    });
  }

  // Boot
  window.addEventListener('hashchange', render);
  window.addEventListener('DOMContentLoaded', ()=>{
    $('#openDonate')?.addEventListener('click', ()=> openDonateModal());
    // removed bottom floating donate handler because the floating donate element was removed per request

    $('#openGoogleFormBtn')?.addEventListener('click', ()=> window.open(LINKS.DONATE,'_blank'));

    window.addEventListener('keydown', (e)=>{
      if (e.key === 'd' && !e.ctrlKey && !e.metaKey && !e.altKey) openDonateModal();
      if (e.key === '/' && notInInput()){
        e.preventDefault();
        const fs = document.getElementById('finderSearch'); fs && fs.focus();
      }
    });

    function notInInput(){
      return !['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName);
    }

    $$('.navlink').forEach(a => a.addEventListener('click', ()=> setActiveNav(a.getAttribute('href').replace(/^#/,''))));

    render();
    updateStats();
    readyToast();

    // Register SW via blob
    registerSWBlob();
  });

  // Service Worker registration via Blob
  function registerSWBlob(){
    if (!('serviceWorker' in navigator)) return;
    const swCode = `
      const CACHE_NAME = 'hungerhero-cache-v1';
      const ASSETS = ['/', '/?source=sw'];
      self.addEventListener('install', event => { self.skipWaiting(); event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(ASSETS)).catch(()=>{})); });
      self.addEventListener('activate', event => { event.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch', event => {
        if (event.request.method !== 'GET') return;
        event.respondWith(fetch(event.request).then(r => { if (r && r.type === 'basic') { const copy = r.clone(); caches.open(CACHE_NAME).then(cache => cache.put(event.request, copy)); } return r; }).catch(()=> caches.match(event.request).then(resp => resp || caches.match('/'))));
      });
    `;
    try {
      const blob = new Blob([swCode], {type: 'application/javascript'});
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).then(reg => { console.log('SW registered (blob)', reg); }).catch(err=> console.warn('SW reg failed', err));
    } catch(e){ console.warn('sw blob err', e); }
  }

  // expose some helpers for debugging
  window.hh = { centers: () => centers, reloadCenters: ()=> { centers = loadCenters(); }, saveCenters: ()=> saveCenters(centers), toast };

  // Export functions for templates
  window.openDonateModal = openDonateModal;
  window.loadStats = loadStats;
  window.renderFeatured = renderFeatured;
  window.openPopupForCenter = openPopupForCenter;
  window.addAllMarkers = addAllMarkers;

})(); // IIFE
  </script>
</body>
</html>
